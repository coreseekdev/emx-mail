# emx-b4 使用说明

基于邮件的 Git 补丁工作流工具，灵感来自 [b4](https://github.com/mricon/b4)。

用于处理邮件列表中的补丁：解析 mbox、提取 trailer、管理补丁系列、通过 `git am` 应用补丁。

## 安装

```bash
cd emx-mail
go build -o emx-b4 ./cmd/b4/
```

前置条件：`git` 在 PATH 中可用。

## 命令一览

```
emx-b4 <命令> [选项]

am       从 mbox 创建 git-am 可用的补丁
shazam   直接将补丁应用到当前仓库
prep     准备补丁系列（创建/管理/生成）
diff     比较两个版本的补丁系列
mbox     解析并显示 mbox 文件信息
```

---

## am — 生成 git-am 可用的 mbox

从邮件列表的 mbox 文件中提取补丁系列，输出可直接用于 `git am` 的 mbox。

自动完成：提取最新版本、收集 follow-up trailer（Reviewed-by、Acked-by 等）、零填充补丁编号。

```bash
# 基本用法：从 mbox 生成 am-ready 补丁
emx-b4 am -m patches.mbox -o ready.mbox

# 选择特定版本
emx-b4 am -m patches.mbox -v 2 -o ready-v2.mbox

# 添加 Link trailer
emx-b4 am -m patches.mbox --add-link --link-prefix "https://lore.kernel.org/r/"

# 添加 Message-Id trailer
emx-b4 am -m patches.mbox --add-message-id

# 将封面信的 trailer 应用到所有补丁
emx-b4 am -m patches.mbox --apply-cover-trailers -o ready.mbox

# 从 stdin 读取
cat patches.mbox | emx-b4 am -o ready.mbox

# 输出到 stdout（可管道给 git am）
emx-b4 am -m patches.mbox | git am
```

| 选项 | 说明 |
|------|------|
| `-m, --mbox <文件>` | 输入 mbox 文件（默认 stdin） |
| `-o, --output <文件>` | 输出文件（默认 stdout） |
| `-v, --revision <N>` | 选择版本号（默认最新） |
| `-3, --3way` | 启用三路合并 |
| `--add-link` | 添加 `Link:` trailer |
| `--link-prefix <URL>` | Link 前缀（如 `https://lore.kernel.org/r/`） |
| `--add-message-id` | 添加 `Message-Id:` trailer |
| `--apply-cover-trailers` | 封面信 trailer 应用到所有补丁 |

---

## shazam — 直接应用补丁

等同于 `am` + `git am`，一步到位将补丁应用到当前 git 仓库。

```bash
# 直接应用
emx-b4 shazam -m patches.mbox

# 选择 v2 版本，启用三路合并
emx-b4 shazam -m patches.mbox -v 2 -3

# 从 stdin
cat patches.mbox | emx-b4 shazam
```

| 选项 | 说明 |
|------|------|
| `-m, --mbox <文件>` | 输入 mbox 文件（默认 stdin） |
| `-v, --revision <N>` | 选择版本号 |
| `-3, --3way` | 启用三路合并 |

> 应用失败时使用 `git am --abort` 回退。

---

## prep — 管理补丁系列

在 git 分支上管理补丁系列的完整生命周期：创建分支、编辑封面信、生成补丁、版本升级。

### prep new — 创建补丁分支

```bash
# 基于当前分支创建
emx-b4 prep new fix-null-ptr

# 指定基础分支
emx-b4 prep new fix-null-ptr -b main

# 使用 -n 显式指定
emx-b4 prep new -n my-feature -b develop
```

创建 `b4/fix-null-ptr` 分支，并初始化 `.b4/` 跟踪目录。

### prep cover — 编辑封面信

```bash
emx-b4 prep cover -s "修复空指针系列" -b "本系列修复了 foo 和 bar 模块的空指针问题。"
```

### prep status — 查看当前状态

```bash
emx-b4 prep status
```

输出示例：

```
分支:     b4/fix-null-ptr
版本:     v1
基础分支: main
Change-ID: fix-null-ptr
封面主题: 修复空指针系列

提交 (2):
  1. Fix null pointer in foo()
  2. Fix null pointer in bar()

变更统计:
 foo.c | 2 +-
 bar.c | 3 ++-
 2 files changed, 3 insertions(+), 2 deletions(-)
```

### prep patches — 生成补丁文件

```bash
# 输出到指定目录
emx-b4 prep patches -o ./outgoing/

# 默认使用临时目录
emx-b4 prep patches
```

### prep reroll — 版本升级

当补丁需要修改重发时：

```bash
emx-b4 prep reroll
# 输出: 版本已升级: v1 → v2
```

后续补丁的 Subject 会自动变为 `[PATCH v2 N/M]`。

### prep list — 列出所有补丁分支

```bash
emx-b4 prep list
```

---

## diff — 比较补丁版本

比较同一 mbox 中不同版本的补丁系列差异。

```bash
# 比较 v1 和 v2
emx-b4 diff -m thread.mbox -r 1..2
```

输出示例：

```
== 比较 v1 (3 个补丁) vs v2 (3 个补丁) ==

补丁 1: 相同 - Fix null pointer in foo
补丁 2: 变更
  v1: Fix null pointer in bar
  v2: Fix null pointer in bar (improved)
补丁 3: 相同 - Update documentation
```

---

## mbox — 查看 mbox 信息

解析 mbox 文件，显示补丁系列结构。

```bash
emx-b4 mbox patches.mbox
```

输出示例：

```
消息总数: 5
版本数:   2
未分类:   0

== 版本 v1 ==
  封面信: Fix null pointer issues
  补丁数: 2/2
  [1] Fix null pointer in foo
      Signed-off-by: Author <author@example.com>
  [2] Fix null pointer in bar
      Signed-off-by: Author <author@example.com>

== 版本 v2 ==
  封面信: Fix null pointer issues (improved)
  补丁数: 2/2
  [1] Fix null pointer in foo
      Signed-off-by: Author <author@example.com>
      Reviewed-by: Reviewer <reviewer@kernel.org>
  [2] Fix null pointer in bar (improved)
      Signed-off-by: Author <author@example.com>
```

---

## 补丁格式说明

### Subject 解析

工具自动识别以下格式的邮件主题：

```
[PATCH]           单个补丁
[PATCH 2/5]       系列中第 2 个（共 5 个）
[PATCH v3 2/5]    第 3 版
[PATCH RFC 1/3]   RFC 草稿
[PATCH RESEND]    重发
Re: [PATCH 1/3]   回复（follow-up）
```

### Trailer 类型

自动识别并分类：

| 类型 | 示例 |
|------|------|
| **人员** | `Signed-off-by:` `Reviewed-by:` `Acked-by:` `Tested-by:` `Cc:` |
| **工具** | `Fixes:` `Link:` `Closes:` `Change-Id:` |
| **未知** | 其他 `Key: value` 格式 |

### Follow-up Trailer

当审阅者回复补丁邮件并添加 trailer（如 `Reviewed-by:`）时，`am` 和 `shazam` 会自动将这些 trailer 收集并附加到对应补丁中。

---

## 典型工作流

### 接收补丁（审阅者/维护者）

```bash
# 1. 获取邮件线程的 mbox（从邮件客户端导出或从 lore 下载）
# 例如: curl -o patches.mbox "https://lore.kernel.org/...t.mbox.gz" | gunzip

# 2. 查看补丁信息
emx-b4 mbox patches.mbox

# 3. 生成 am-ready 版本（收集所有 review trailer）
emx-b4 am -m patches.mbox --apply-cover-trailers -o ready.mbox

# 4a. 手动应用
git am ready.mbox

# 4b. 或一步到位
emx-b4 shazam -m patches.mbox
```

### 发送补丁（开发者）

```bash
# 1. 创建补丁分支
emx-b4 prep new my-feature -b main

# 2. 正常开发，提交代码
git add .
git commit -m "Fix: 修复空指针"

# 3. 编写封面信
emx-b4 prep cover -s "修复空指针系列" -b "详细说明..."

# 4. 查看状态
emx-b4 prep status

# 5. 生成补丁文件
emx-b4 prep patches -o ./outgoing/

# 6. 通过 emx-mail CLI 发送（或其他邮件工具）
# emx-mail send -to maintainer@kernel.org -subject "..." -text "..." -attachment 0001-xxx.patch

# 7. 收到 review 意见后修改，升级版本
# ... 修改代码 ...
emx-b4 prep reroll
emx-b4 prep patches -o ./outgoing-v2/
```

---

## pkg/patchwork API 概览

`emx-b4` 的核心逻辑封装在 `pkgs/patchwork` 包中，可独立使用：

```go
import "github.com/emx-mail/cli/pkgs/patchwork"

// 解析补丁主题
ps := patchwork.ParseSubject("[PATCH v3 2/5] Fix bug")
fmt.Println(ps.Revision)  // 3
fmt.Println(ps.Counter)   // 2
fmt.Println(ps.Subject)   // "Fix bug"

// 解析 trailer
t := patchwork.ParseTrailer("Signed-off-by: Author <a@b.com>")
fmt.Println(t.Name)   // "Signed-off-by"
fmt.Println(t.Email)  // "a@b.com"

// 从 mbox 读取补丁系列
mb := patchwork.NewMailbox()
mb.ReadMbox(reader)
series := mb.GetLatestSeries()

// 生成 git-am 可用的 mbox
data, _ := series.GetAMReady(patchwork.AMReadyOptions{
    ApplyCoverTrailers: true,
})

// Git 操作
git := patchwork.NewGit(".")
git.AMFromBytes(data, false)
```
